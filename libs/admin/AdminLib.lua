local players = game:GetService("Players")
local textChat = game:GetService("TextChatService")
local repStorage = game:GetService("ReplicatedStorage")
local chatFolder = repStorage:FindFirstChild("DefaultChatSystemChatEvents")
local plr = players.LocalPlayer

local adminLib = {}

adminLib.New = function (options)
  local handler = {}
  local configOptions = {}
  local commandsList = {}
  if not options or not (type(options) == "table") then
    error("New options should be a valid table.")
  end
  for i, v in pairs(options) do
    configOptions[i] = v
  end
  if not configOptions.Prefix or not (type(configOptions.Prefix) == "string") then
    error("Prefix should be a valid string.")
  end
  if not configOptions.Admins or not (type(configOptions.Admins) == "table") then
    error("Admins should be a valid table.")
  end
  
  -- Commands Handler
  
  handler.RegisterCommand = function (registerOptions)
    if not registerOptions or not (type(registerOptions) == "table") then
      error("Register options should be a valid table.")
    end
    if not registerOptions.Name or not (type(registerOptions.Name) == "string") or not registerOptions.Callback or not (type(registerOptions.Callback) == "function") then
      error("Invalid Name or Callback value.")
    end
    commandsList[string.lower(registerOptions.Name)] = {
      ["NoAdmin"] = registerOptions.NoAdmin,
      ["Callback"] = registerOptions.Callback
    }
  end
  
  -- Messages Handler
  
  textChat.MessageReceived:Connect(function (message)
    if not message or not message.Text or not message.TextChannel or not message.TextSource or not message.TextSource.UserId then return end
    if not table.find(configOptions.Admins, message.TextSource.UserId) then return end
    local adminPlr = players:GetPlayerByUserId(message.TextSource.UserId)
    if not adminPlr then return end
    
    if not string.find(message.Text, "^" .. configOptions.Prefix) then return end
    local command = string.match(message.Text, "^" .. configOptions.Prefix .. "(%S+)")
    local findCommand = commandsList[string.lower(command)]
    if not findCommand then return end
    if findCommand.NoAdmin and table.find(configOptions.Admins, plr.UserId) then return end
    local plainArgs = string.match(message.Text, "^" .. configOptions.Prefix .. command .. "%s*(.+)")
    local args = {}
    if plainArgs and string.len(plainArgs) > 0 then
      args = string.split(plainArgs, " ")
    end
    task.spawn(findCommand.Callback, {
      ["CommandName"] = command,
      ["PlainArgs"] = plainArgs,
      ["Args"] = args,
      ["Admin"] = adminPlr,
      ["Reply"] = function (text)
        if chatFolder then
          chatFolder.SayMessageRequest:FireServer(text, "All")
        else
          message.TextChannel:SendAsync(text)
        end
      end
    })
  end)
  
  return handler
end

return adminLib